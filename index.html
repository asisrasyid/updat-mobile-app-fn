<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Managament Finance</title>
		<link rel="manifest" href="manifest.json" />
		<meta name="theme-color" content="#4CAF50" />
  		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/906/906334.png" />

		<!-- all css -->
		<link rel="stylesheet" href="assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="assets/css/jquery-ui.css" />
		<link rel="stylesheet" href="assets/css/slick.css" />
		<link rel="stylesheet" href="assets/css/line-awesome.css" />
		<link rel="stylesheet" href="assets/css/nice-select.css" />
		<link rel="stylesheet" href="assets/css/style.css" />
		<link rel="stylesheet" href="assets/css/responsive.css" />
		<link rel="stylesheet" href="style2.css"/>
	</head>

	<body>
		<div id="loadingOverlay" style="display:none;">
            <div class="spinner"></div>
          </div>
		<!-- Preloader -->
		<!-- <div class="preloader">
			<img src="assets/images/preloader.gif" alt="preloader" />
		</div> -->

		<!-- Settings -->
		<div class="theme_settings">
			<button type="button" id="settings_toggler">
				<i class="las la-cog"></i>
			</button>
			<h3>Settings</h3>

			<h5>Primary Colors</h5>
			<div class="setting_colors">
				<button data-color="#FD3D57" class="prime_1 change_prime_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#3498db" class="prime_2 change_prime_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#1abc9c" class="prime_3 change_prime_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#F79F1F" class="prime_4 change_prime_color">
					<i class="icon las la-check"></i>
				</button>
			</div>

			<h5>Secondary Colors</h5>
			<div class="setting_colors">
				<button data-color="#18181b" class="second_1 change_sec_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#1e293b" class="second_2 change_sec_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#374151" class="second_3 change_sec_color">
					<i class="icon las la-check"></i>
				</button>
				<button data-color="#44403c" class="second_4 change_sec_color">
					<i class="icon las la-check"></i>
				</button>
			</div>
            <h5>System shortcut</h5>
			<div class="mt-2">                 
				<button type="button" id="pembahruandata" class="default_btn_filter">
					 Reload
				</button>
			</div>
			<h5>Filter Data</h5>
			<div class="mt-2">
				<button class="default_btn_filter">Week</button>
				<button class="default_btn_filter">Month</button>
				<button class="default_btn_filter">Year</button> 
				</div>
			</div>
		</div>
		<!-- top header -->
		<header class="home-3">
			<div class="container">
				<div class="d-flex align-items-center justify-content-sm-between">
					<div class="logo">
					</div>
					<div class="search_wrap d-none d-lg-block">
					</div>
					<div class="header_icon d-flex align-items-center ms-auto ms-sm-0">
						<div class="shopcart">
						</div>
						<div class="position-relative myacwrap home-1">
							<a href="javascript:void(0)" class="icon_wrp text-center myacc">
								<span class="icon">
									<i class="las la-user-circle" style="font-size: 30px;"></i>
								</span>
								<span class="icon_text">Account</span>
							</a>
							<div class="myacc_cont">
								<div class="ac_links">
									<a href="account.html" class="myac">
										<i class="lar la-id-card"></i>
										My Account
									</a>
									<a href="settup-fn.html">
										<i class="las la-robot"></i>
										Setting
									</a>
									<a href="javascript:void(0)" id="LogOutSistem">
										<i class="las la-power-off"></i>
										Log out
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</header>
		<!-- mobile bottom bar -->
		<div class="mobile_bottombar d-block d-lg-none">
			<div class="header_icon">
				<a href="index.html" class="icon_wrp text-center">
					<span class="icon">
						<i class="las la-chart-bar"></i>
					</span>
					<span class="icon_text">Dashboard</span>
				</a>
				<a href="javascript:void(0)" class="icon_wrp text-center open_menu">
					<span class="icon">
						<i class="las la-bars"></i>
					</span>
					<span class="icon_text">Menu</span>
				</a>
				<a href="Transaksi-save.html" class="icon_wrp text-center">
					<span class="icon">
						<i class="las la-edit"></i>
					</span>
					<span class="icon_text">Simpan Transaksi</span>
				</a>
			</div>
		</div>

		<!-- mobile menu -->
		<div class="mobile_menwrap d-lg-none" id="mobile_menwrap">
			<div class="mobile_menu_2">
				<h5 class="mobile_title">
					Menu
					<span class="sidebarclose" id="menuclose">
						<i class="las la-times"></i>
					</span>
				</h5>
				<ul>
					<li class="">
						<a href="index.html">Dashboard</a>
					</li>

					<li class="">
						<a href="plan-saveing.html">Saveing-Plan</a>
						<!-- <div class="submn">
							<a href="shop-list.html">List View</a>
							<a href="shop-grid.html">Grid View</a>
							<a href="shop-grid-2.html">Grid View 2</a>
							<a href="wish-list.html">Wishlist</a>
							<a href="shopping-cart.html">Shopping cart</a>
							<a href="product-view.html">Product view</a>
						</div> -->
					</li>
					<li class=""> 
						<a href="budgeting-view.html">Budgeting</a>
						<!-- <div class="submn">
							<a href="account.html">My account</a>
							<a href="login.html">Login</a>
							<a href="register.html">Register</a>
							<a href="forgot-password.html">Forgot password</a>
						</div> -->
					</li>
					<li class="">
						<a href="riwayat-transaksi.html">Riyawat Transaksi</a>
						<!-- <div class="submn">
							<a href="account.html">My account</a>
							<a href="login.html">Login</a>
							<a href="register.html">Register</a>
							<a href="forgot-password.html">Forgot password</a>
						</div> -->
					</li>
					<!-- <li class="">
						<a href="">Setting </a>
						<div class="submn">
							<a href="about-us.html">about us</a>
							<a href="contact-us.html">Contact us</a>
							<a href="track-order.html">Track order</a>
							<a href="faq.html">FAQ</a>
							<a href="404.html">404</a>
							<a href="checkout.html">Checkout</a>
							<a href="payment.html">Payment</a>
							<a href="order-completed.html">Order complete</a>
						</div>
					</li> -->
				</ul>
			</div>
		</div>

		<!-- hero area -->		
		<div class="container-lg home_2_hero_wrp home-3 mt-4">
			<div class="row">
				<div class="col-xl-9">
					<div class="home_2_hero">
						<div class="container">
							<div class="hero_slider_active">
								<div class="single_hero_slider">
									<div class="hero_content m-4">
										<p>Jangan Lupa isi Catatan Keuangannya</p>
										<h1>
											Hallo! <strong class="output"></strong><br class="d-block d-sm-none" />
											Semangat yaa!
										</h1>
										<div class="hero_btn">
											<a class="default_btn small rounded" href="Transaksi-save.html">Catat Transaksi</a>
										</div>
									</div>
								</div>
								<div class="single_hero_slider">
									<div class="container">
										<div class="hero_content">
											<p><strong class="output"></strong> dicatat ya Pengeluarannya</p>
											<h1>Punya rencana Menabung? yuk buat!</h1>
											<div class="hero_btn">
												<a class="default_btn small rounded" href="plan-saveing.html">Rencanan Tabungan</a>
											</div>
										</div>
									</div>
								</div>
								<div class="single_hero_slider">
									<div class="container">
										<div class="hero_content">
											<p>coba cek deh <strong class="output"></strong></p>
											<h1>Pengeluarannya sudah sesuai rencana ?</h1>
											<div class="hero_btn">
												<a class="default_btn small rounded" href="budgeting-view.html">Data Transaksi</a>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-xl-3">
					<!-- Summary Cards -->
					<div class="card mt-2">
						<div class="card-body p-2">
							<div class="row g-2">
								<div class="col-6">
									<div class="d-flex align-items-center p-2 rounded" style="background: rgba(78, 115, 223, 0.1);">
										<div class="flex-shrink-0">
											<i class="las la-money-bill fa-lg text-primary"></i>
										</div>
										<div class="flex-grow-1 ms-2">
											<div class="small text-muted">Pemasukan</div>
											<div class="fw-bold text-primary" id="totalPemasukan">Rp 0</div>
										</div>
									</div>
								</div>
								<div class="col-6">
									<div class="d-flex align-items-center p-2 rounded" style="background: rgba(28, 200, 138, 0.1);">
										<div class="flex-shrink-0">
											<i class="las la-shopping-cart fa-lg text-success"></i>
										</div>
										<div class="flex-grow-1 ms-2">
											<div class="small text-muted">Pengeluaran</div>
											<div class="fw-bold text-success" id="totalPengeluaran">Rp 0</div>
										</div>
									</div>
								</div>
								<div class="col-6">
									<div class="d-flex align-items-center p-2 rounded" style="background: rgba(54, 185, 204, 0.1);">
										<div class="flex-shrink-0">
											<i class="las la-piggy-bank fa-lg text-info"></i>
										</div>
										<div class="flex-grow-1 ms-2">
											<div class="small text-muted">Tabungan</div>
											<div class="fw-bold text-info" id="totalTabungan">Rp 0</div>
										</div>
									</div>
								</div>
								<div class="col-6">
									<div class="d-flex align-items-center p-2 rounded" style="background: rgba(246, 194, 62, 0.1);">
										<div class="flex-shrink-0">
											<i class="las la-wallet fa-lg text-warning"></i>
										</div>
										<div class="flex-grow-1 ms-2">
											<div class="small text-muted">Sisa Budget</div>
											<div class="fw-bold text-warning" id="sisaBudget">Rp 0</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="card mt-2">
						<h4 class="text-dark card-header bg-white">Saldo Terkini</h4>
						<div class="card-body p-2">
							<div class="row g-2" id="dataaccount">
							</div>
						</div>
					</div>
					<div class="card mt-2">
						<h4 class="text-dark card-header bg-white">List Hutang</h4>
						<div class="card-body p-2">
							<div class="row g-2" id="DataHutang">
							</div>
						</div>
					</div>
					<div class="shop_cart_wrap wishlist single_shop_cart_index">
						<ul class="nav nav-tabs" id="financeTab" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active" id="savings-tab" data-bs-toggle="tab" data-bs-target="#savings" type="button" role="tab">
									Rencana Tabungan
								</button>
							</li>
							<li class="nav-item" role="presentation">
								<button class="nav-link" id="budget-tab" data-bs-toggle="tab" data-bs-target="#budget" type="button" role="tab">
									Budgeting
								</button>
							</li>
						</ul>
						<div class="tab-content p-3" id="financeTabContent">
							<div class="tab-pane fade show active" id="savings" role="tabpanel">
								<div id="data-container">
									<!-- Rencana tabungan akan ditampilkan di sini -->
								</div>
								<div class="shop_cart_wrap wishlist single_shop_cart_index">
									<div class="row justify-content-center">
										<a class="default_btn small rounded" href="plan-saveing.html">Lihat Rencanan Tabungan</a>
									</div>
								</div>
							</div>
							<div class="tab-pane fade" id="budget" role="tabpanel">
								<div id="budget-container">
									<!-- Progress budget akan ditampilkan di sini -->
								</div>
								<div class="shop_cart_wrap wishlist single_shop_cart_index">
									<div class="row justify-content-center">
										<a class="default_btn small rounded" href="plan-saveing.html">Lihat Budgeting</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Dashboard Summary -->
		<section class="container-lg mt-3 >
			<!-- Charts Row -->
				<div class="row">
					<!-- Distribusi Pengeluaran -->
					<div class="col-12 col-sm-6 h-100">
						<div class="card m-0 mb-4">
							<div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
								<h4 class="m-0 text-dark">Distribusi Pengeluaran</h6>
								<span class="badge bg-primary">Bulan Ini</span>
							</div>
							<div class="card-body">
								<div class="Pengeluaran-distribution">
									<!-- Items will be populated by JavaScript -->
								</div>
							</div>
						</div>
					</div>

					<!-- Tren Keuangan -->
					<div class="col-12 col-sm-6 h-100">
						<div class="card mb-4">
							<div class="card-header  bg-white py-3 d-flex justify-content-between align-items-center">
								<h4 class="m-0 text-dark">Tren Keuangan</h6>
								<div class="dropdown">
									<button class="btn btn-link dropdown-toggle" type="button" id="trendFilterButton" data-bs-toggle="dropdown">
										<i class="las la-filter"></i> Filter
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#" data-period="week">Minggu Ini</a></li>
										<li><a class="dropdown-item" href="#" data-period="month">Bulan Ini</a></li>
										<li><a class="dropdown-item" href="#" data-period="year">Tahun Ini</a></li>
									</ul>
								</div>
							</div>
							<div class="card-body">
								<div class="trend-list">
									<!-- Items will be populated by JavaScript -->
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Recent Transactions -->
				<div class="row">
					<div class="col-12">
						<div class="card  mb-4">
							<div class="card-header  bg-white py-3 d-flex justify-content-between align-items-center">
								<h4 class="m-0 text-dark">Transaksi Terakhir</h6>
								<div class="dropdown">
									<button class="btn btn-link dropdown-toggle" id="dropdownMenuButton" data-bs-toggle="dropdown">
										<i class="las la-filter"></i> Filter
									</button>
									<ul class="dropdown-menu">
										<li><a class="dropdown-item" href="#">Semua</a></li>
										<li><a class="dropdown-item" href="#">Pemasukan</a></li>
										<li><a class="dropdown-item" href="#">Pengeluaran</a></li>
									</ul>
								</div>
							</div>
							<div class="card-body">
								<div id="recentTransactions" class="transaction-list">
									<!-- Transactions will be populated by JavaScript -->
								</div>
							</div>
						</div>
					</div>
				</div>
		</section>

		<!-- copyright -->
		<div class="copyright_wrap">
			<div class="container">
				<div class="row align-items-center">
					<div class="col-md-6">
						<p class="copyright_text">2025 | Finance Management</p>
					</div>
				</div>
			</div>
		</div>
		<script>
			if ("serviceWorker" in navigator) {
 				 window.addEventListener("load", function () {
    			navigator.serviceWorker.register("/service-worker.js").then(
      			function (registration) {
        		console.log("ServiceWorker berhasil:", registration.scope);
      		},
      		function (err) {
        		console.log("ServiceWorker gagal:", err);
      			}
    			);
  			});
			}

		</script> 
		<!-- all js -->
		<script src="assets/js/bootstrap.bundle.min.js"></script>
		<script src="assets/js/jquery-3.5.1.min.js"></script>
		<script src="assets/js/jquery-ui.min.js"></script>
		<script src="assets/js/slick.min.js"></script>
		<script src="assets/js/jquery.nice-select.min.js"></script>
		<script src="assets/js/app.js"></script>
		<script src="assets/js/theme-manager.js"></script>n
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
		const urlGet = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset="

		const spreadsheetUrl = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset=accdta"; 
		const savedUser = localStorage.getItem('user');
    	const outputElements = document.querySelectorAll('.output');
		if (savedUser) {
			outputElements.forEach(el => el.textContent = savedUser);
			loadBudgetProgress();
		 }
		 else {
			window.location.href = "login.html"; 	
		 }
		
		async function EndPointHit (param) {
			const GetDatabase = `${urlGet}${param}`;
			try {
    			const res = await fetch(GetDatabase);
    			const json = await res.json();

				if(json && json.values){
					return json.values;
				} else if (json && json.value) {
					return json.value;
				} else {
					return json;
				}
  			} catch (err) {
    			console.error('Gagal ambil data:', err);
    			return [];
  			}
		}

		//DATA TRANSKASI GET
		async function updateDashboardData() {
			const data = await EndPointHit("resTrx")
			if (!Array.isArray(data)) {
				console.error('Data harus berupa array:', data);
				return;
			}
			const summary = calculateSummary(data);
			const chartData = processChartData(data);
			const recentTransactions = getRecentTransactions(data);
			updateSummaryCards(summary);
			updateCharts(chartData);
			updateRecentTransactions(recentTransactions);
		}
		async function GetDataLoanList() {
			const data = await EndPointHit("bckdata")
			const loanData = data.byLoan
			LoanAccount(loanData)

		}
		async function LoanAccount(data) {
			const container = document.getElementById('DataHutang');
			container.innerHTML = '';
			
			const colorClasses = ['card-color-1', 'card-color-2', 'card-color-3', 'card-color-4', 'card-color-5'];
			const textClass = ['text-color-1', 'text-color-2', 'text-color-3', 'text-color-4', 'text-color-5'];
			
			//const data = await EndPointHit("DataAccRek")
			console.log(data)
			data.forEach((item, index) => {
				if(item.status.toLowerCase() === "belum lunas") {
					let el = document.createElement('div');
				el.className = 'col-12';
				const randomClass = colorClasses[index % colorClasses.length];
				const rancolo = textClass[index % textClass.length];
				el.innerHTML = `
				  <div class="d-flex align-items-center p-2 rounded ${randomClass}" );">
					<div class="flex-grow-1 ms-2">
						<div class="small text-muted">${item.KeteranganLoan}</div>
						<div class="fw-bold ${rancolo}" >${formatRupiah(item.nilaiHutang)}</div>
						<div class="d-flex gap-3 "> 
							<div class="small text-success fw-semibold"> 
								 ${item.jatuhTempo ? formatDate(item.jatuhTempo) : "Tanggal Kosong"}
							</div>
							<div class="small text-danger fw-semibold">${item.status}</div>
						</div>
					</div>
				</section>
				`;
				container.appendChild(el);
				}
			});
		}
		GetDataLoanList()
		//LIST SALDO
		async function tampilDataAccount () {
			const container = document.getElementById('dataaccount');
			container.innerHTML = '';
			
			const colorClasses = ['card-color-1', 'card-color-2', 'card-color-3', 'card-color-4', 'card-color-5'];
			const textClass = ['text-color-1', 'text-color-2', 'text-color-3', 'text-color-4', 'text-color-5'];
			
			const data = await EndPointHit("DataAccRek")
			
			data.forEach((item, index) => {
				const el = document.createElement('div');
				el.className = 'col-12';
				const randomClass = colorClasses[index % colorClasses.length];
				const rancolo = textClass[index % textClass.length];
				el.innerHTML = `
				  <div class="d-flex align-items-center p-2 rounded ${randomClass}" );">
					<div class="flex-grow-1 ms-2">
						<div class="small text-muted">${item.Keterangan}</div>
						<div class="fw-bold ${rancolo}" >${formatRupiah(item.Nilai)}</div>
						<div class="d-flex gap-3 "> 
							<div class="small text-success fw-semibold"> +${formatRupiah(item.Pemasukan)}</div>
							<div class="small text-danger fw-semibold"> -${formatRupiah(item.Pengeluaran)}</div>
						</div>
					</div>
				</section>
				`;
				container.appendChild(el);
			});
		}
		tampilDataAccount()	
		updateDashboardData()
		// Fungsi untuk memuat dan menampilkan progress budget
		function loadBudgetProgress() {
			const budgetData = [
				{
					kategori: "MAKANAN & MINUMAN",
					target: 2000000,
					terpakai: 1500000,
					persen_tercapai: 75
				},
				{
					kategori: "TRANSPORTASI",
					target: 1000000,
					terpakai: 400000,
					persen_tercapai: 40
				},
				{
					kategori: "HIBURAN DAN JALAN-JALAN",
					target: 500000,
					terpakai: 600000,
					persen_tercapai: 120
				}
			];

			const container = document.getElementById('budget-container');
			container.innerHTML = '';
			budgetData.forEach(item => {
				const el = document.createElement('div');
				el.className = 'd-flex align-items-center flex-wrap';
				
				const melebihiTarget = item.terpakai > item.target;
				const persentaseKelebihan = melebihiTarget ? ((item.terpakai / item.target) * 100 - 100).toFixed(1) : 0;
				
				const progressBarClass = melebihiTarget ? 'bg-danger' : '';
				
				const progressWidth = melebihiTarget ? 100 : item.persen_tercapai;
				
				el.innerHTML = `
					<div class="cart_cont w-100">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<h6 class="mb-0">${item.kategori}</h6>
							${melebihiTarget ? 
								`<span class="badge bg-danger">
									<i class="las la-exclamation-triangle"></i> 
									Melampaui  ${persentaseKelebihan}%
								</span>` : 
								''}
						</div>
						<div class="page-wrap">
							<div class="meter">
								<span class="progress ${progressBarClass}" style="width: ${progressWidth}%"></span>
								<div class="label">${formatRupiah(item.terpakai)} dari ${formatRupiah(item.target)}</div>
							</div>
						</div>
					</div>
				`;
				container.appendChild(el);
			});
		}

		//TAMPIL DATA CARD RESUME
		function updateSummaryCards(summary) {
			document.getElementById('totalPemasukan').textContent = formatRupiah(summary.totalPemasukan);
			document.getElementById('totalPengeluaran').textContent = formatRupiah(summary.totalPengeluaran);
			document.getElementById('totalTabungan').textContent = formatRupiah(summary.totalTabungan);
			document.getElementById('sisaBudget').textContent = formatRupiah(summary.sisaBudget);
		}
		//TAMPIL DATA DISTIRIBUSI PENGELUARAN TREN KEUANGAN DAN TRANSKASI TERAKHIR
		function updateCharts(chartData) {
			console.log(chartData)
			const PengeluaranDistribution = document.querySelector('.Pengeluaran-distribution');
			if (PengeluaranDistribution) {
				PengeluaranDistribution.innerHTML = '';
				
				const totalPengeluaran = chartData.amounts.reduce((sum, amount) => sum + amount, 0);
				
				chartData.categories.forEach((category, index) => {
					const amount = chartData.amounts[index];
					const percentage = ((amount / totalPengeluaran) * 100).toFixed(1);
					
					const PengeluaranItem = document.createElement('div');
					PengeluaranItem.className = 'Pengeluaran-item mb-3';
					
					let icon = 'las la-ellipsis-h';
					let iconColor = 'text-secondary';
					
					switch(category.toLowerCase()) {
						case 'makanan':
							icon = 'las la-utensils';
							iconColor = 'text-primary';
							break;
						case 'transportasi':
							icon = 'las la-car';
							iconColor = 'text-success';
							break;
						case 'hiburan':
							icon = 'las la-film';
							iconColor = 'text-info';
							break;
						case 'belanja':
							icon = 'las la-shopping-bag';
							iconColor = 'text-warning';
							break;
						case 'utilitas':
							icon = 'las la-lightbulb';
							iconColor = 'text-danger';
							break;
						case 'lainnya':
							icon = 'las la-ellipsis-h';
							iconColor = 'text-secondary';
							break;
					}
					
					PengeluaranItem.innerHTML = `
						<div class="d-flex justify-content-between align-items-center mb-1">
							<div class="d-flex align-items-center">
								<span class="fw-bold">${category}</span>
							</div>
							<span class="text-dark">${formatRupiah(amount)}</span>
						</div>
						<div class="progress" style="height: 8px;">
							<div class="progress-bar ${iconColor.replace('text-', 'bg-')}" 
								 role="progressbar" 
								 style="width: ${percentage}%" 
								 aria-valuenow="${percentage}" 
								 aria-valuemin="0" 
								 aria-valuemax="100">
							</div>
						</div>
						<div class="d-flex justify-content-between mt-1">
							<small class="text-muted">${percentage}% dari total</small>
							<small class="text-muted">Target: ${formatRupiah(amount * 1.2)}</small>
						</div>
					`;
					
					PengeluaranDistribution.appendChild(PengeluaranItem);
				});
			}

			// Update tren keuangan
			const trendList = document.querySelector('.trend-list');
			if (trendList) {
				trendList.innerHTML = '';
				
				// Gabungkan data pemasukan dan pengeluaran
				const trendData = chartData.months.map((month, index) => ({
					month: month,
					Pemasukan: chartData.Pemasukan[index],
					Pengeluaran: chartData.Pengeluaran[index],
					balance: chartData.Pemasukan[index] - chartData.Pengeluaran[index]
				}));

				// Tampilkan data tren
				trendData.forEach(item => {
					const trendItem = document.createElement('div');
					trendItem.className = 'trend-item';
					
					const monthName = formatMonthName(item.month);
					const balanceClass = item.balance >= 0 ? 'Pemasukan' : 'Pengeluaran';
					
					trendItem.innerHTML = `
						<div class="trend-header">
							<span class="trend-date">${monthName}</span>
							<span class="trend-amount ${balanceClass}">
								${formatRupiah(Math.abs(item.balance))}
								${item.balance >= 0 ? '(Surplus)' : '(Defisit)'}
							</span>
						</div>
						<div class="trend-details mb-2">
								<span class="trend-category">Pemasukan: ${formatRupiah(item.Pemasukan)}</span>
						</div>
						<div class="trend-details">
								<span class="trend-category text-danger">Pengeluaran: ${formatRupiah(item.Pengeluaran)}</span>
						</div>

					`;
					
					trendList.appendChild(trendItem);
				});
			}
		}

		function formatRupiah(angka) {
			angka = Number(angka);
			
			if (isNaN(angka) || angka === 0) {
				return 'Rp 0';
			}
			
			if (angka >= 1000000000) {
				return 'Rp ' + (angka / 1000000000).toFixed(1) + ' Milyar';
			}
			
			if (angka >= 1000000) {
				return 'Rp ' + (angka / 1000000).toFixed(1) + ' Juta';
			}
			
			if (angka >= 1000) {
				return 'Rp ' + (angka / 1000).toFixed(1) + ' Ribu';
			}
			
			return 'Rp ' + angka.toString();
		}

		function formatMonthName(monthKey) {
			const [year, month] = monthKey.split('-');
			const date = new Date(year, month - 1);
			return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
		}

		function formatDate(dateStr) {
			const date = new Date(dateStr);
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
			return date.toLocaleDateString('id-ID', options);
		}

		function formatTime(dateStr) {
			const date = new Date(dateStr);
			return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
		}

		function formatBulanTahun(dateStr) {
				const bulan = [
					'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
					'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
				];
			  const date = new Date(dateStr);
			  const namaBulan = bulan[date.getMonth()];
			  const tahun = date.getFullYear();
			  return `${namaBulan}-${tahun}`;
		}

		function updateRecentTransactions(transactions) {
			const container = document.getElementById('recentTransactions');
			container.innerHTML = '';

			// Mengelompokkan transaksi berdasarkan tanggal
			const groupedTransactions = transactions.reduce((groups, transaction) => {
				const date = transaction.tanggal;
				if (!groups[date]) {
					groups[date] = [];
				}
				groups[date].push(transaction);
				return groups;
			}, {});

			// Mengurutkan tanggal dari yang terbaru
			Object.keys(groupedTransactions)
				.sort((a, b) => new Date(b) - new Date(a))
				.forEach(date => {
					const dateGroup = document.createElement('div');
					dateGroup.className = 'mb-3';
					
					// Menambahkan header tanggal
					const dateHeader = document.createElement('div');
					dateHeader.className = 'transaction-date mb-2';
					dateHeader.textContent = formatDate(date);
					dateGroup.appendChild(dateHeader);

					// Menambahkan transaksi untuk tanggal tersebut
					groupedTransactions[date].forEach(transaction => {
						let card;
						if(transaction.jenis ==="Perpindahan") {
						card = document.createElement('div');
						card.className = `transaction-card ${transaction.jenis}`;
						card.innerHTML = `
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<h6 class="mb-1 text-success fw-semibold"> + ${transaction.subKategori}</h6>
									<h6 class="mb-1 text-danger fw-semibold"> - ${transaction.kategori}</h6>
									<span class="transaction-category"> ${transaction.keterangan} </span>
								</div>
								<div class="text-end">
									<div class="transaction-amount text-success">
										${formatRupiah(transaction.jumlah)}
									</div>
									<div class="transaction-date">${formatTime(transaction.tanggal)}</div>
								</div>
							</div>
						`;
						} else {
						card = document.createElement('div');
						card.className = `transaction-card ${transaction.jenis}`;
						card.innerHTML = `
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<h6 class="mb-1">${transaction.keterangan}</h6>
									<span class="transaction-category">${transaction.kategori} / ${transaction.subKategori} </span>
								</div>
								<div class="text-end">
									<div class="transaction-amount ${transaction.jenis}">
										${transaction.jenis === 'Pemasukan' ? '+' : '-'} ${formatRupiah(transaction.jumlah)}
									</div>
									<div class="transaction-date">${formatTime(transaction.tanggal)}</div>
								</div>
							</div>
						`;
						}
						dateGroup.appendChild(card);
					});

					container.appendChild(dateGroup);
				});
		}

		document.getElementById("LogOutSistem").addEventListener("click", function (e) {
			  e.preventDefault(); 
			  localStorage.clear(); 
			  window.location.href = "index.html"; 
			});
				
		function tampilkanDataKeUI(data) {
			const container = document.getElementById('data-container');
			container.innerHTML = '';
			  const top3 = data.slice(0, 3);

			  top3.forEach(item => {
				const el = document.createElement('div');
				el.className = 'd-flex align-items-center flex-wrap';
				el.innerHTML = `
				  <div class="cart_cont">
					<a href="product-view.html"><h5>${item.judul}</h5></a>
				  </div>
				  <div class="page-wrap">  
					<div class="meter">
					  <span class="progress" style="width: ${item.persen_tercapai}%"></span>
					  <div class="label">${item.persen_tercapai}% dari  ${formatRupiah(item.target_nominal)}</div>
					</div>
				  </div>
				`;
				container.appendChild(el);
			  });
			  $('.preloader').fadeOut(500, function(){ $('.preloader').remove(); } );
			}

		function ambilData() {
				const dataLocal = localStorage.getItem('saving_plan_Index');
				const spreadsheetUrlSvdt = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset=trgSave"; 
	
				if (dataLocal) {
				  const parsedData = JSON.parse(dataLocal);
				  tampilkanDataKeUI(parsedData);
				} else {
				  fetch(spreadsheetUrlSvdt) 
					.then(res => res.json())
					.then(res => {
					  localStorage.setItem('saving_plan_Index', JSON.stringify(res.value));
					  tampilkanDataKeUI(res.value);
					})
					.catch(err => console.error('Gagal ambil data:', err));
				}
			}

		document.addEventListener('DOMContentLoaded', ambilData);
		
		const submitButton = document.getElementById("pembahruandata");   
		document.getElementById("pembahruandata").addEventListener("click", function(event) {
				event.preventDefault();
				document.getElementById("loadingOverlay").style.display = "flex";
				const spreadsheetUrlSvdt = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset=trgSave"; 
				fetch(spreadsheetUrlSvdt) 
					.then(res => res.json())
					.then(res => {
					  localStorage.setItem('saving_plan_Index', JSON.stringify(res.value));
					  window.location.reload();
					})
				.catch(err => {
					console.error('Gagal ambil data:', err); 
					document.getElementById("loadingOverlay").style.display = "none";
				});
			});

		// function syncData() {
		// 	const spreadsheetUrl = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset=resTrx";
		// 	const spreadsheetUrlSvdt = "https://script.google.com/macros/s/AKfycbyBfKNeW5yhAyL8BdaJo6AhkbVfEPeorcqOMjPElrCCZJU9sQpCKpWwGAAqSYqKSqFw2g/exec?dataset=trgSave";
			
		// 	// Sinkronisasi data transaksi
		// 	fetch(spreadsheetUrl)
		// 		.then(res => res.json())
		// 		.then(res => {
		// 			if (res && res.value && Array.isArray(res.value)) {
		// 				localStorage.setItem('transaction_data', JSON.stringify(res.value));
		// 				updateDashboardData(res.value);
		// 			} else {
		// 				console.error('Format data transaksi tidak valid:', res);
		// 				// Gunakan data dummy jika format tidak valid
		// 				const dummyData = [
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pemasukan',
		// 						kategori: 'Gaji',
		// 						jumlah: 15000000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Gaji bulan ini'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'Makanan',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Makan siang'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'transportasi',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'hiburan',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'belanja',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'utilitas',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					},
		// 					{
		// 						tanggal: new Date().toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'lainnya',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					},
		// 					{
		// 						tanggal: new Date("2025-01-01").toISOString().split('T')[0],
		// 						jenis: 'Pengeluaran',
		// 						kategori: 'lainnya',
		// 						jumlah: 500000,
		// 						subKategori: "Bolo Bolo",
		// 						keterangan: 'Jalan-jalan'
		// 					}

		// 				];
		// 				updateDashboardData(dummyData);
		// 			}
		// 		})
		// 		.catch(err => {
		// 			console.error('Gagal sinkronisasi data transaksi:', err);
		// 			// Gunakan data dari localStorage jika ada
		// 			const savedData = localStorage.getItem('transaction_data');
		// 			if (savedData) {
		// 				try {
		// 					const parsedData = JSON.parse(savedData);
		// 					if (Array.isArray(parsedData)) {
		// 						updateDashboardData(parsedData);
		// 					}
		// 				} catch (e) {
		// 					console.error('Gagal memparse data dari localStorage:', e);
		// 				}
		// 			}
		// 		});

		// 	// Sinkronisasi data tabungan
		// 	fetch(spreadsheetUrlSvdt)
		// 		.then(res => res.json())
		// 		.then(res => {
		// 			if (res && res.value && Array.isArray(res.value)) {
		// 				localStorage.setItem('saving_plan_Index', JSON.stringify(res.value));
		// 				tampilkanDataKeUI(res.value);
		// 			} else {
		// 				console.error('Format data tabungan tidak valid:', res);
		// 			}
		// 		})
		// 		.catch(err => {
		// 			console.error('Gagal sinkronisasi data tabungan:', err);
		// 			// Gunakan data dari localStorage jika ada
		// 			const savedData = localStorage.getItem('saving_plan_Index');
		// 			if (savedData) {
		// 				try {
		// 					const parsedData = JSON.parse(savedData);
		// 					if (Array.isArray(parsedData)) {
		// 						tampilkanDataKeUI(parsedData);
		// 					}
		// 				} catch (e) {
		// 					console.error('Gagal memparse data dari localStorage:', e);
		// 				}
		// 			}
		// 		});
		// }

		function calculateSummary(data) {
			console.log("data" + data)
			if (!Array.isArray(data)) {
				console.error('Data harus berupa array:', data);
				return {
					totalPemasukan: 0,
					totalPengeluaran: 0,
					totalTabungan: 0,
					sisaBudget: 0
				};
			}

			return {
				totalPemasukan: data.reduce((sum, item) => item.jenis === 'Pemasukan' ? sum + (Number(item.jumlah) || 0) : sum, 0),
				totalPengeluaran: data.reduce((sum, item) => item.jenis === 'Pengeluaran' ? sum + (Number(item.jumlah) || 0) : sum, 0),
				totalTabungan: data.reduce((sum, item) => item.kategori === 'Tabungan' ? sum + (Number(item.jumlah) || 0) : sum, 0),
				sisaBudget: data.reduce((sum, item) => {
					if (item.jenis === 'Pemasukan') return sum + (Number(item.jumlah) || 0);
					if (item.jenis === 'Pengeluaran') return sum - (Number(item.jumlah) || 0);
					return sum;
				}, 0)
			};
		}

		function processChartData(data) {
			if (!Array.isArray(data)) {
				console.error('Data harus berupa array:', data);
				return {
					categories: [],
					amounts: [],
					months: [],
					Pemasukan: [],
					Pengeluaran: []
				};
			}

			const categories = {};
			const months = {};
			
			data.forEach(item => {
				// Proses data kategori
				if (item.jenis === 'Pengeluaran') {
					if (!categories[item.kategori]) {
						categories[item.kategori] = 0;
					}
					categories[item.kategori] += Number(item.jumlah) || 0;
				}
				
				// Proses data bulanan
				const date = new Date(item.tanggal);
				const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
				if (!months[monthKey]) {
					months[monthKey] = { Pemasukan: 0, Pengeluaran: 0 };
				}
				if (item.jenis === 'Pemasukan') {
					months[monthKey].Pemasukan += Number(item.jumlah) || 0;
				} else if (item.jenis === 'Pengeluaran') {
					months[monthKey].Pengeluaran += Number(item.jumlah) || 0;
				}
			});

			// Jika tidak ada data transaksi, gunakan data dummy
			if (Object.keys(categories).length === 0) {
				return {
					categories: ['Makanan', 'Transportasi', 'Hiburan', 'Belanja', 'Utilitas', 'Lainnya'],
					amounts: [2500000, 1500000, 1000000, 2000000, 1000000, 500000],
					months: ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'],
					Pemasukan: [12000000, 13500000, 12800000, 14200000, 15000000, 15000000],
					Pengeluaran: [7500000, 8200000, 7800000, 8900000, 8200000, 8500000]
				};
			}

			return {
				categories: Object.keys(categories),
				amounts: Object.values(categories),
				months: Object.keys(months).sort(),
				Pemasukan: Object.values(months).map(m => m.Pemasukan),
				Pengeluaran: Object.values(months).map(m => m.Pengeluaran)
			};
		}

		function getRecentTransactions(data) {
			return data
				.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))
				.slice(0, 10);
		}

		document.addEventListener('DOMContentLoaded', () => {
			updateDashboardData();
			// Sinkronisasi setiap 5 menit
			setInterval(updateDashboardData, 300000);
		});
		</script>
	</body>
</html>
